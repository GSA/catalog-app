version: 2
jobs:
  build:
    machine: true
    steps:
      - checkout
      - run:
          name: Run tests
          command: make test

  deploy_cloud_gov:
    machine: true
    steps:
      - checkout
      - run:
          command: |
            curl -v -L -o cf-cli_amd64.deb 'https://cli.run.pivotal.io/stable?release=debian64&source=github'
            sudo dpkg -i cf-cli_amd64.deb
      - run:
          command: |
            ./vendor-requirements.sh
      - run:
          command: |
            cf api https://api.fr.cloud.gov            
            cf auth
            cf target -o gsa-datagov -s development
            cf push --vars-file vars.ci.yaml
            cf logs catalog-ci-fgdc2iso --recent
            cf logs catalog-ci-solr --recent
            cf logs catalog-ci --recent
      # - run:
      #     command: |
      #       guid=`cf curl /v3/apps?names=catalog-ci | jq -r '.resources[].guid'`
      #       uri=`cf curl/v3/apps/$guid/env | jq -r '.application_env_json.VCAP_APPLICATION.uris[0]'`
      #      curl https://$uri

workflows:
  version: 2
  main:
    jobs:
      - vendor_requirements
      - deploy_cloud_gov:
          requires:
            - vendor_requirements
#      - build
